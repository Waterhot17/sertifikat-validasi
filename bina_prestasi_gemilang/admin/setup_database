<?php
$page_title = "Setup Database";
require_once '../includes/config.php';
require_once 'header.php';

// Koneksi database
$conn = new mysqli(DB_HOST, DB_USER, DB_PASS);
if ($conn->connect_error) {
    die("Koneksi database gagal: " . $conn->connect_error);
}

$success = [];
$errors = [];

// Cek apakah database sudah ada
if (isset($_POST['action']) && $_POST['action'] == 'setup') {
    // 1. Buat database jika belum ada
    $sql = "CREATE DATABASE IF NOT EXISTS " . DB_NAME . " CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci";
    if ($conn->query($sql)) {
        $success[] = "Database '" . DB_NAME . "' berhasil dibuat";
    } else {
        $errors[] = "Gagal membuat database: " . $conn->error;
    }
    
    // Pilih database
    $conn->select_db(DB_NAME);
    
    // 2. Buat tabel users
    $sql = "CREATE TABLE IF NOT EXISTS users (
        id INT AUTO_INCREMENT PRIMARY KEY,
        username VARCHAR(50) UNIQUE NOT NULL,
        password VARCHAR(255) NOT NULL,
        nama_lengkap VARCHAR(100) NOT NULL,
        email VARCHAR(100),
        level ENUM('superadmin', 'admin', 'operator') DEFAULT 'operator',
        is_active TINYINT(1) DEFAULT 1,
        last_login DATETIME NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        deleted_at DATETIME NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";
    
    if ($conn->query($sql)) {
        $success[] = "Tabel 'users' berhasil dibuat";
        
        // Tambah user admin default jika tabel kosong
        $check = $conn->query("SELECT COUNT(*) as count FROM users");
        $row = $check->fetch_assoc();
        if ($row['count'] == 0) {
            $password_hash = password_hash('admin123', PASSWORD_DEFAULT);
            $sql = "INSERT INTO users (username, password, nama_lengkap, email, level) 
                    VALUES ('admin', '$password_hash', 'Administrator', 'admin@example.com', 'admin')";
            if ($conn->query($sql)) {
                $success[] = "User admin default berhasil dibuat (username: admin, password: admin123)";
            }
        }
    } else {
        $errors[] = "Gagal membuat tabel users: " . $conn->error;
    }
    
    // 3. Buat tabel jenis_sertifikat
    $sql = "CREATE TABLE IF NOT EXISTS jenis_sertifikat (
        id INT AUTO_INCREMENT PRIMARY KEY,
        kode_jenis VARCHAR(20) UNIQUE NOT NULL,
        nama_jenis VARCHAR(100) NOT NULL,
        deskripsi TEXT,
        masa_berlaku INT DEFAULT 365,
        is_active TINYINT(1) DEFAULT 1,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";
    
    if ($conn->query($sql)) {
        $success[] = "Tabel 'jenis_sertifikat' berhasil dibuat";
    }
    
    // 4. Buat tabel sertifikat
    $sql = "CREATE TABLE IF NOT EXISTS sertifikat (
        id INT AUTO_INCREMENT PRIMARY KEY,
        nomor_sertifikat VARCHAR(50) UNIQUE NOT NULL,
        kode_unik VARCHAR(50) UNIQUE NOT NULL,
        nama_peserta VARCHAR(100) NOT NULL,
        jenis_id INT,
        tanggal_terbit DATE NOT NULL,
        tanggal_expired DATE NOT NULL,
        institusi VARCHAR(100),
        program VARCHAR(100),
        email VARCHAR(100),
        no_hp VARCHAR(20),
        qr_code VARCHAR(255),
        file_path VARCHAR(255),
        status ENUM('active', 'inactive', 'expired') DEFAULT 'active',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (jenis_id) REFERENCES jenis_sertifikat(id) ON DELETE SET NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";
    
    if ($conn->query($sql)) {
        $success[] = "Tabel 'sertifikat' berhasil dibuat";
    }
    
    // 5. Buat tabel activity_logs
    $sql = "CREATE TABLE IF NOT EXISTS activity_logs (
        id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT,
        activity_type VARCHAR(50) NOT NULL,
        description TEXT NOT NULL,
        ip_address VARCHAR(45),
        user_agent TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";
    
    if ($conn->query($sql)) {
        $success[] = "Tabel 'activity_logs' berhasil dibuat";
    }
    
    // 6. Buat tabel validation_logs
    $sql = "CREATE TABLE IF NOT EXISTS validation_logs (
        id INT AUTO_INCREMENT PRIMARY KEY,
        certificate_id INT,
        validation_time DATETIME NOT NULL,
        ip_address VARCHAR(45),
        user_agent TEXT,
        result ENUM('valid', 'invalid', 'expired') NOT NULL,
        FOREIGN KEY (certificate_id) REFERENCES sertifikat(id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";
    
    if ($conn->query($sql)) {
        $success[] = "Tabel 'validation_logs' berhasil dibuat";
    }
    
    // 7. Buat tabel import_log
    $sql = "CREATE TABLE IF NOT EXISTS import_log (
        id INT AUTO_INCREMENT PRIMARY KEY,
        filename VARCHAR(255) NOT NULL,
        total_rows INT NOT NULL,
        success_count INT NOT NULL,
        failed_count INT NOT NULL,
        status VARCHAR(20) NOT NULL,
        user_id INT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";
    
    if ($conn->query($sql)) {
        $success[] = "Tabel 'import_log' berhasil dibuat";
    }
    
    // 8. Buat tabel settings
    $sql = "CREATE TABLE IF NOT EXISTS settings (
        id INT AUTO_INCREMENT PRIMARY KEY,
        setting_key VARCHAR(100) UNIQUE NOT NULL,
        setting_value TEXT,
        category VARCHAR(50) DEFAULT 'general',
        type VARCHAR(20) DEFAULT 'text',
        options TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";
    
    if ($conn->query($sql)) {
        $success[] = "Tabel 'settings' berhasil dibuat";
        
        // Insert default settings
        $default_settings = [
            ['site_name', SITE_NAME, 'general', 'text'],
            ['institution_name', SITE_NAME, 'general', 'text'],
            ['contact_email', 'info@example.com', 'general', 'text'],
            ['certificate_format', 'BPG-{YEAR}-{SEQ}', 'certificate', 'text'],
            ['default_expiry', '365', 'certificate', 'number'],
            ['auto_generate_qr', '1', 'certificate', 'checkbox']
        ];
        
        foreach ($default_settings as $setting) {
            $sql = "INSERT IGNORE INTO settings (setting_key, setting_value, category, type) 
                    VALUES ('$setting[0]', '$setting[1]', '$setting[2]', '$setting[3]')";
            $conn->query($sql);
        }
    }
}
?>

<div class="page-header">
    <h1><i class="fas fa-database me-2"></i>Setup Database</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="dashboard.php">Dashboard</a></li>
            <li class="breadcrumb-item active">Setup Database</li>
        </ol>
    </nav>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Setup Database Sistem</h5>
            </div>
            <div class="card-body">
                <?php if (!empty($errors)): ?>
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Error:</h6>
                    <ul class="mb-0">
                        <?php foreach ($errors as $error): ?>
                        <li><?php echo $error; ?></li>
                        <?php endforeach; ?>
                    </ul>
                </div>
                <?php endif; ?>
                
                <?php if (!empty($success)): ?>
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle me-2"></i>Success:</h6>
                    <ul class="mb-0">
                        <?php foreach ($success as $msg): ?>
                        <li><?php echo $msg; ?></li>
                        <?php endforeach; ?>
                    </ul>
                </div>
                <?php endif; ?>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Sistem akan membuat database dan tabel-tabel yang diperlukan.
                </div>
                
                <form method="POST">
                    <input type="hidden" name="action" value="setup">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-play me-1"></i> Jalankan Setup Database
                    </button>
                </form>
                
                <div class="mt-4">
                    <h6>Tabel yang akan dibuat:</h6>
                    <ul class="small">
                        <li><code>users</code> - Tabel pengguna sistem</li>
                        <li><code>jenis_sertifikat</code> - Jenis-jenis sertifikat</li>
                        <li><code>sertifikat</code> - Data sertifikat</li>
                        <li><code>activity_logs</code> - Log aktivitas sistem</li>
                        <li><code>validation_logs</code> - Log validasi sertifikat</li>
                        <li><code>import_log</code> - Log import data</li>
                        <li><code>settings</code> - Pengaturan sistem</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Status Database</h6>
            </div>
            <div class="card-body">
                <?php
                // Cek status database
                $db_exists = $conn->select_db(DB_NAME);
                
                if ($db_exists) {
                    echo '<p><span class="badge bg-success">Database ada</span> ' . DB_NAME . '</p>';
                    
                    // Cek tabel
                    $tables = ['users', 'jenis_sertifikat', 'sertifikat'];
                    echo '<h6 class="mt-3">Tabel:</h6>';
                    foreach ($tables as $table) {
                        $result = $conn->query("SHOW TABLES LIKE '$table'");
                        if ($result->num_rows > 0) {
                            echo '<p><i class="fas fa-check text-success me-2"></i> ' . $table . '</p>';
                        } else {
                            echo '<p><i class="fas fa-times text-danger me-2"></i> ' . $table . '</p>';
                        }
                    }
                } else {
                    echo '<p><span class="badge bg-danger">Database tidak ditemukan</span></p>';
                }
                ?>
            </div>
        </div>
    </div>
</div>

<?php 
$conn->close();
require_once 'footer.php'; 
?>